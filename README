Read the documentation in qemu-doc.html or on http://wiki.qemu-project.org

- QEMU team


一、安装过程
================
######1、下载源代码
目前QEMU的版本是2.0.0
./configure 进行配置，--target-list选项可以指定目标机器的平台，还有其他很多选项，参见./configure --help
然后执行make命令

######2、简单系统下安装busybox  
下载busybox1.22.1源代码  
编译对应平台的busybox  
修改busybox目录下的Makefile  
第293行："LD =$(CC) -nostdlib " -->"LD =$(CC) -nostdlib -m32"  
参见configs/busybox/Makefile文件
以x86_32为例
make ARCH=i386 deconfig  
make ARCH=i386 menuconfig  
1.修改Busybox SettingsBuild Option  [*]Build Busybox as a static binary(no shared libs)  
2.[Busybox Settings]--->  
     [Build Options]--->  
        (-m32) Additional CFLAGS  
        (-m32) Additional LDFLAGS  
3.去掉不需要的功能，其它模块编译错误做法类似  
  Networking Utilities --->   
      [ ] inetd 
最终的配置文件参见configs/busybox/config文件
4.make ARCH=i386
5.make ARCH=i386 install

######3、qemu模拟linux
1）、编写initrd启动脚本，其中BUSYBOX是busybox的路径
  cd  BUSYBOX/_install
  mkdir proc sys dev etc 
  cd etc
  mkdir init.d
  vim BUSYBOX/_install/etc/init.d/rcS
“#!/bin/sh
  mount -t proc none /proc
  mount -t sysfs none /sys
  /sbin/mdev -s
”
参见configs/busybox/rcS文件
          
2）、编写构建initrd镜像脚本
  vim BUSYBOX/kernel/build-initrd.sh
              “#!/bin/sh
               KERNEL=$(pwd)
               BUSYBOX=busybox的路径
               cd $BUSYBOX/_install
               find . |cpio -o --format=newc > $KERNEL/rootfs.img
               cd $KERNEL
               gzip -c rootfs.img >rootfs.img.gz”
参见configs/busybox/build-initrd.sh文件               
               
               
3)、编写启动脚本
 vim BUSYBOX/kernel/run.sh
 注：以下代码不要复制粘贴！请手动输入！！
"#!/bin/sh
/home/XXX/qemu/i386-softmmu/qemu-system-i386 -kernel /home/LINUX/arch/i386/boot/bzImage -initrd rootfs.img -append "root=/dev/ram rdinit=sbin/init" –d exec –D qemu.log"
参见configs/busybox/run.sh文件
 ./run.sh  运行busybox系统
其中bzImage是linux内核编译出的文件，在arch/i386/boot文件夹下，rootfs.img是上一步创建的镜像文件
-d 参数可以指定日志记录的项目，其中exec是执行翻译块（TB）的记录，数量非常多，速度会很慢
我对qemu做了一定的修改，使它会记录每一个执行的tb，并增加了-d的一个选项 func可以只追踪函数调用
-D 参数指定将日志输出到这个文件中

4.可加载模块
编译可加载模块，代码应满足一定的格式
示例参见configs/module/factorial.c文件
并要有Makefile，参见configs/module/Makefile文件
将编译好的.ko文件放到busybox-1.22.1/_install/lib/modules/3.5.4/extra/文件夹下，
在虚拟机中执行modprobe或insmod命令（具体使用可参考Linux使用帮助）载入模块






